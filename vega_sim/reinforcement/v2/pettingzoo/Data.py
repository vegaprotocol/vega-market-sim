import matplotlib.pyplot as plt
import inspect
import numpy as np
import pandas as pd

# 30_iter ave
CAC_ave={'Party_A': [4434.192, 4630.633, 4866.0689999999995, 5410.794, 5724.069, 6021.844, 6083.2, 6136.839, 6282.639, 6480.363, 6714.9439999999995, 6793.406, 6814.84, 7426.478], 
         'Party_B': [1513.121, -1086.8980000000001, 2510.513, -320.09799999999996, 4636.112, 4525.322, 3302.962, 3710.96, -20.322000000000116, 769.3990000000003, 4241.503, 481.4470000000001, 1632.6499999999996, 3643.252], 
         'Party_C': [-9746.656, -8270.049, -8859.478, -5622.7880000000005, -2859.2819999999992, -12551.127, -2062.0159999999996, -7365.214, -10109.063, -6179.312, -6278.366, -12906.241000000002, -6596.114, -12800.578000000001]}
STD_ave={'Party_A': 853.9787106230627, 'Party_B': 1869.9342858272835, 'Party_C': 3296.4006364731417}
AVE_ave={'Party_A': 5987.165, 'Party_B': 2109.9945000000002, 'Party_C': -8014.734571428572}
COM_ave={'Party_A': 0.1426349049379903, 'Party_B': 0.8862270900835444, 'Party_C': 0.4112925521232303}

# single_iter
CAC_single={'Party_A': [-8003.760775, -3284.3207749999997, -2729.788775, -641.0087749999999, -408.355775, -202.58077500000002, -33.595775, 488.855225, 643.5362250000001, 778.690225, 1176.385225, 1684.389225, 2373.154225, 2496.863225, 2556.002225, 2995.343225, 3820.229225, 3963.549225, 6604.272225, 8787.144225], 
            'Party_B': [-8150.998775000001, -3567.2967750000003, -3664.5747749999996, -2114.9997749999998, -341.153775, 172.54422499999998, -860.2987750000001, 34.28222500000004, 176.207225, 561.620225, 229.692225, -535.9217749999999, 2207.369225, 1638.5022250000002, 1368.081225, 1621.764225, 3390.212225, 1103.854225, 2663.905225, 6305.537225], 
            'Party_C': [-12860.018774999999, -5526.448775000001, -6097.424775, -4751.055775000001, -2852.272775, -214.696775, -5339.034775, -1109.6577750000001, -120.552775, 456.382225, 159.81122499999998, -933.7307750000001, 456.872225, -2650.605775, 1144.848225, 1116.634225, 1472.872225, -1311.4367750000001, 308.385225, 2115.396225]}
max_CAC_single= {'Party_A': 8787.144225, 'Party_B': 6305.537225, 'Party_C': 2115.396225}
min_CAC_single= {'Party_A': -8003.760775, 'Party_B': -8150.998775000001, 'Party_C': -12860.018774999999}
mean_single={'Party_A': 1153.250125, 'Party_B': 111.91637500000004, 'Party_C': -1826.7867250000006}
std_single={'Party_A': 3466.301515981723, 'Party_B': 2915.623907786021, 'Party_C': 3508.6995898290643}
arsd_CAC_single= {'party_1': 3.0056805898735304, 'party_2': 26.051807948443823, 'party_3': -1.9206947049766103}

# Volatility to 150
sigma200={'Party_A': [-9378.608019999996, -5863.0024050000075, -2445.856109999986, -2344.0569300000075, -1790.6911850000183, -1085.9102450000078, -1012.2941600000344, -317.0093100000061, -316.15899500001393, 43.3983949999776, 115.35069499996699, 179.9688849999794, 307.5723649999942, 320.95408499999934, 737.2000949999914, 1021.9247949999874, 2153.446149999994, 3823.2888850000018, 5727.38001000001, 6689.711715000018], 
          'Party_C': [-8049.400020000012, 11184.463869999978, 6008.6103900000235, -14893.924090000035, -6153.344970000044, 1244.981719999991, 3572.5485700000127, -1306.2084400000167, -1492.932929999958, -901.9406399999862, 1212.2207599999606, -4955.4218300000175, -4395.742579999955, 2712.938060000044, -2955.1910800000114, -5737.27836000001, -607.1405500000515, 3863.2839499999827, -20529.462260000026, -2548.5921300000077], 
          'Party_B': [-32127.744110000018, 7109.122119999961, -1688.536430000034, -1995.7959699999885, -10225.919839999997, -527.4211400000072, -5508.667220000036, -1482.8705000000195, -279.8648500000331, -2000.349070000019, 1482.772869999987, 250.480399999966, 6804.683850000005, -6150.070589999975, 1187.0783399999716, -3283.634529999985, 2395.0745300000144, 2051.3116400000054, 4969.577560000003, 5449.72465999997]}
max_sigma200= {'Party_A': 6689.711715000018, 'Party_C': 11184.463869999978, 'Party_B': 7109.122119999961}
min_sigma200= {'Party_A': -9378.608019999996, 'Party_C': -20529.462260000026, 'Party_B': -32127.744110000018}
mean_sigma200= {'Party_A': -171.66956425000808, 'Party_C': -2236.376628000007, 'Party_B': -1678.5524140000114}
std_sigma200= {'Party_A': 3445.8267226556864, 'Party_C': 6864.111792242652, 'Party_B': 8178.041085654863}
arsd_sigma200= [-20.07243822,  -3.06930045,  -4.87207967]

# q to 10
q10={'Party_A': [-13145.536200000017, -13040.776549999977, -7542.745194999989, -2653.9289349999926, -1428.4670200000048, -1163.2184949999953, -1162.1171749999694, -962.6505499999959, -205.71336500001814, 37.04742500002519, 468.4098899999718, 685.5089900000103, 828.4460050000051, 1838.7707750000395, 1881.796295000007, 4840.768345000023, 5202.212250000028, 5594.57532500001, 7767.27484500001, 8503.181455000005], 
     'Party_C': [-23058.29084, -16779.879379999984, 1548.1454099999687, -2111.653270000017, -4846.540430000002, -638.8326099999854, -2067.902129999952, -4956.775559999971, -2249.284240000041, -23315.66730999999, -28554.748989999964, -448.1780800000089, -14776.375620000032, 7155.664620000005, -15022.399899999962, -18412.296039999994, -5534.08935, -6490.548569999952, -20294.98940999997, -14921.098859999947], 
     'Party_B': [-1952.1301299999961, 8367.22602, 7102.986699999985, 9649.529850000024, 686.0015200000332, 17.28473999999985, -4249.69622, 5122.006150000011, -251.87729999999283, -2130.185869999983, 933.7878699999792, 993.5490599999972, 4164.09915000001, 135.4008099999628, -650.7893700000295, 9215.52883999996, 9784.78377999999, -39219.19721999998, -12521.236000000019, 8490.274939999985]}
max_q10= {'Party_A': 8503.181455000005, 'Party_C': 7155.664620000005, 'Party_B': 9784.78377999999}
min_q10= {'Party_A': -13145.536200000017, 'Party_C': -28554.748989999964, 'Party_B': -39219.19721999998}
mean_q10= {'Party_A': -182.85809424999132, 'Party_C': -9788.78702799999, 'Party_B': 184.36736599999693}
std_q10= {'Party_A': 5632.836500294738, 'Party_C': 9649.36298691591, 'Party_B': 10567.389450513685}
arsd_q10= [-30.80441434,  -0.98575676,  57.31702784]

# limited liquidity 1e3
lq1e3={'Party_A': [-1033.3234299999945, -457.3475250000037, -364.7491149999951, -207.81808000000416, -152.7292099999978, -132.42678999999703, -127.1302500000111, -114.28248499996616, -101.85702500002388, -70.45644500001063, -33.16105499997502, -32.58582999998238, -26.161430000001474, -22.295339999981874, -4.974945000011288, -2.990770000014222, 82.73345999997167, 92.67565499998256, 601.763730000004, 670.0387849999879], 
       'Party_C': [0.0, -6.76264999999907, 197.99286000000507, -82.61939000002806, 1340.4982699999925, 3.1989500000001954, -48.49863000000604, -27.446439999986346, 0.6177000000038186, -17.482810000026692, 0.0, 204.10226000001654, -212.52342999997418, 0.0, 12.743079999993, -5.646379999977071, -492.82989000002146, -162.50523000000732, -1294.534100000001, -422.30306999997936], 
       'Party_B': [-1180.5274299999787, 1249.949589999984, -138.91094000003943, 210.31284999998752, -359.7188199999649, 342.42398000002873, -16.267620000003742, -9.203919999984185, -374.674010000017, -16.983909999971836, -96.50782999998061, -180.4558400000306, -20.96689000004381, -44.564379999982094, 761.3523899999949, -101.32347999995751, -84.37670999996746, -357.41427000002994, 243.78458999999566, 1301.8154899999872]}
max_lq1e3= {'Party_A': 670.0387849999879, 'Party_C': 1340.4982699999925, 'Party_B': 1301.8154899999872}
min_lq1e3= {'Party_A': -1033.3234299999945, 'Party_C': -1294.534100000001, 'Party_B': -1180.5274299999787}
mean_lq1e3= {'Party_A': -71.85390475000122, 'Party_C': -50.69994499999978, 'Party_B': 56.38714200000131}
std_lq1e3= {'Party_A': 336.54131525718986, 'Party_C': 447.5201871705566, 'Party_B': 541.6120948733095}
arsd_lq1e3= [-4.68368861, -8.82683772,  9.60524112]

# buy_int 5
buyint5={'Party_A': [-21840.278255000056, -11271.414684999982, -7326.398899999995, -5492.824475000003, -4189.309195, -3077.008580000043, -1314.102229999979, -624.2393400000163, -9.80222500000093, 0.0, 112.10805000001818, 161.82240499996715, 333.2708700000024, 374.221650000005, 591.3648199999723, 1362.4339599999894, 4029.5074400000112, 4179.864039999995, 8417.989959999966, 17579.551095000003], 
         'Party_C': [-43669.13423000001, -45679.865150000005, -11411.791609999978, -89456.00492999995, -19581.855710000003, -3212.85992000003, -3866.883079999966, -8643.804539999965, -49.82774000002434, 0.0, -10528.779670000024, -549.1044299999921, -108.2234599999696, -1246.9298300000466, -1831.228660000023, -1591.1700100000137, -52832.83402999998, -4771.192880000043, -64576.629629999996, -50242.65912999997], 
         'Party_B': [-19254.52902999999, -7929.999499999976, -4213.280109999998, -3680.4010100000305, -36839.21468999999, -5139.026440000032, 272.1792100000173, 5101.694439999963, -193.81908000004245, 0.0, -8.092460000000301, -7264.090819999989, -28.174619999995834, -698.5881799999954, -5449.187979999977, 282.5961400000285, 3636.136169999986, 1874.1189700000057, -894.4903699999926, -16931.349140000002]}
max_buyint5= {'Party_A': 17579.551095000003, 'Party_C': 0.0, 'Party_B': 5101.694439999963}
min_buyint5= {'Party_A': -21840.278255000056, 'Party_C': -89456.00492999995, 'Party_B': -36839.21468999999}
mean_buyint5= {'Party_A': -900.1621797500077, 'Party_C': -20692.538932, 'Party_B': -4867.875925000001}
std_buyint5= {'Party_A': 7473.038353285886, 'Party_C': 26146.907078427008, 'Party_B': 9454.90539673327}
arsd_buyint5= [-8.30187995, -1.2635910, -1.94230616]

# multiplier 3
mul3={'Party_A': [-1814.326579999993, -1191.0969250000066, -527.6540700000012, -461.27255500001525, -237.43658499995874, -137.75293000000875, -118.31636500000498, 834.3874100000025, 845.8759750000298, 857.1240149999715, 941.3250500000231, 1117.797145000012, 1615.1065200000176, 1778.9191650000053, 2524.722469999977, 2625.7591950000115, 3143.9704100000354, 3552.4344299999775, 3658.805515000006, 3893.061140000006], 
      'Party_B': [558.342170000004, -1765.2667900000095, -42.51140999999419, -6909.543980000008, -765.3687700000195, -524.3945399999664, 0.0, 349.5303200000283, -1611.076810000024, 4575.489530000021, -1317.9435500000461, 3346.583710000024, -961.7863599999939, -5055.1690199999875, -883.7257300000408, -1618.3488900000345, -5204.1177000000525, 4001.974620000002, -4251.485379999991, -5.122509999999693], 
      'Party_C': [-7088.399180000033, -3748.072709999948, -2843.115710000021, -4523.953300000003, -507.95673000001347, -7904.339939999996, -604.5362600000029, -263.19805000000633, -9467.976060000006, -11203.746650000005, -1097.6087199999695, -1417.7064900000169, -7529.856689999995, -5950.787350000013, -1682.9525099999692, -793.4717399999778, -867.5739700000024, -4980.60589999996, -24531.231889999995, -67.10521000001711]}
max_mul3= {'Party_A': 3893.061140000006, 'Party_B': 4575.489530000021, 'Party_C': -67.10521000001711}
min_mul3= {'Party_A': -1814.326579999993, 'Party_B': -6909.543980000008, 'Party_C': -24531.231889999995}
mean_mul3= {'Party_A': 1145.0716215000043, 'Party_B': -904.1970545000046, 'Party_C': -4853.709752999997}
std_mul3= {'Party_A': 1634.5988549032634, 'Party_B': 2857.655333142513, 'Party_C': 5595.278982440209}
arsd_mul3= [ 1.42750796, -3.16043424, -1.15278401]

# fund 1e4
fund1e4={'Party_A': [-10000.000000000002, -10000.0, -10000.0, -9999.999999999998, -7609.349169999999, -6117.913115, -4042.9817049999997, -4023.2027349999994, -3795.7814399999997, -3777.5180399999995, -3344.7859649999996, -1453.641089999997, -417.2586949999999, 457.68726999999956, 866.674460000001, 1844.8353350000004, 3191.3311700000004, 3340.6249700000003, 5939.359955, 7986.41466], 
         'Party_B': [-10000.0, 4216.159730000001, -9999.999999999998, -10000.0, 682.710069999999, -1817.0319000000018, -10000.0, -10000.0, -10000.0, 2491.0036400000004, -1720.885780000001, -10000.0, -10000.0, 3290.02844, -10000.0, -2447.77779, -3765.587829999999, 1302.1672599999995, 11108.310109999999, -10000.0], 
         'Party_C': [-10000.0, -10000.0, -10000.000000000002, -10000.0, 1694.3505199999984, -10000.0, -3266.6099299999996, -10000.0, -10000.0, -10000.0, -1775.2175799999998, -10000.0, 5296.875770000001, -10000.0, -10000.0, -10000.0, -1901.949910000002, -5162.711310000001, -6092.33916, 4090.430370000001]}
max_fund1e4= {'Party_A': 7986.41466, 'Party_B': 11108.310109999999, 'Party_C': 5296.875770000001}
min_fund1e4= {'Party_A': -10000.000000000002, 'Party_B': -10000.0, 'Party_C': -10000.000000000002}
mean_fund1e4= {'Party_A': -2547.7752067499996, 'Party_B': -4333.0452024999995, 'Party_C': -6355.858561499999}
std_fund1e4= {'Party_A': 5314.881569093481, 'Party_B': 6369.028110009875, 'Party_C': 5103.578705210368}
arsd_fund1e4= [-2.08608733, -1.46987345, -0.80297235]

# CAC
CAC={
    'Party_A': [-3268.1871699999547, -1245.3958700000107, 5841.148844999993, 761.0504699999826, -2130.185210000002, 
                883.9126299999967, 1172.7511549999867, -329.0321450000117, 2535.749369999985, 2521.310620000016, 
                8598.106914999978, 1731.7785450000013, 359.4745250000254, -24023.17164500001, 3818.7235249999844, 
                4668.449315000004, 1446.9120450000269, 5875.566480000004, -4833.658180000006, -112.9832299999991],
    'Party_B': [-4141.627410000002, 291.5177299999915, -2856.5514799999837, -827.1460599999632, -7516.0771199999845, 
                5053.28551, 4801.198100000023, -207.77522999999837, 2218.118760000027, 239.2464600000187, 
                7036.119460000031, -23796.456189999983, -6.387450000017416, -22378.387159999984, -4850.609399999967, 
                130.4307100000033, -7417.094289999988, 2104.0948099999873, -7451.014259999985, -1149.9534800000135],
    'Party_C': [-4285.1628099999925, -6511.334390000037, -16290.278520000007, -3946.3233799999693, -13910.625669999981, 
                -8111.9255799999855, -9629.270940000002, -8639.252729999998, -3136.421930000009, -6364.614440000003, 
                -8583.451289999965, 1959.0987800000096, -89.29152999997149, -37070.13199999998, -3966.123029999972, 
                -16655.762070000008, 5006.8179100000325, -54627.59217, -19159.42632000002, 0.0] ,
}

# AC
AC={
    'Party_A':[-6971.67052, -5000.0, -5000.0, 4564.00453, 1095.49303,
               739.1266000000003, -5000.0, -1421.9719800000003, -5000.0, -215.26612999999998,
               -5000.0, -5000.0, 2609.72716, -1259.8345600000002, 1714.7624999999994,
               -5000.0, 1871.8543899999995, 900.6989999999996, 1628.3040900000005, -5000.0],
    'Party_B':[-5343.6059199999645, -17256.691725000004, -5153.333059999962, -1464.8618949999766, -15.280720000002582, 
               -2904.663410000037, -11130.740215000013, -1437.7943249999937, -2121.4477200000033, 0.0, 
               -7707.369365, -3249.286765000044, -1004.469439999997, -346.7137249999796, -3334.4545000000085, 
               -490.45036000001187, -3365.934100000013, 1796.6882800000155, -817.3964550000048, -3938.7298950000013],
    'Party_C':[-2699.05601999997, -39492.85634000001, 2827.053940000025, -1365.0637899999965, -1665.606450000005, 
                3731.2960200000193, 718.5579499999812, 56.05953000003929, -539.4969800000094, -975.2085399999633, 
                -19518.114510000014, -7952.042530000014, -5735.774759999967, -86.30990999995265, -6490.133899999971, 
                3161.1326100000147, -2934.819380000024, -4745.958380000023, 784.0381300000333, -15938.225729999991],
}

# DQN
DQN={
    'Party_A':[-6971.67052, -5000.0, -5000.0, 4564.00453, 1095.49303,
               739.1266000000003, -5000.0, -1421.9719800000003, -5000.0, -215.26612999999998,
               -5000.0, -5000.0, 2609.72716, -1259.8345600000002, 1714.7624999999994,
               -5000.0, 1871.8543899999995, 900.6989999999996, 1628.3040900000005, -5000.0],
    'Party_B':[-5343.6059199999645, -17256.691725000004, -5153.333059999962, -1464.8618949999766, -15.280720000002582, 
               -2904.663410000037, -11130.740215000013, -1437.7943249999937, -2121.4477200000033, 0.0, 
               -7707.369365, -3249.286765000044, -1004.469439999997, -346.7137249999796, -3334.4545000000085, 
               -490.45036000001187, -3365.934100000013, 1796.6882800000155, -817.3964550000048, -3938.7298950000013],
    'Party_C':[-2699.05601999997, -39492.85634000001, 2827.053940000025, -1365.0637899999965, -1665.606450000005, 
                3731.2960200000193, 718.5579499999812, 56.05953000003929, -539.4969800000094, -975.2085399999633, 
                -19518.114510000014, -7952.042530000014, -5735.774759999967, -86.30990999995265, -6490.133899999971, 
                3161.1326100000147, -2934.819380000024, -4745.958380000023, 784.0381300000333, -15938.225729999991],
}

def retrieve_name(var):
    for fi in reversed(inspect.stack()):
        names = [var_name for var_name, var_val in fi.frame.f_locals.items() if var_val is var]
        if len(names) > 0:
            return names[0]
            
def show_data(model_name,data_dict):
    for (party,data) in data_dict.items():
        plt.plot([i+1 for i in range(len(data))],data,label=party)
    plt.title('%s Algo Tuning Result' % model_name)
    plt.xlabel('Index')
    plt.ylabel('Reward')
    plt.legend()
    plt.show()
    plt.cla()

def sensitivity(model_name,data_dict):
    for (party,data) in data_dict.items():
        plt.plot([i+1 for i in range(len(data))],data,label=party)
    plt.title('%s Sensitivity Test Result' % model_name)
    plt.xlabel('Index')
    plt.ylabel('Reward')
    plt.legend()
    plt.savefig('./figures/ST_%s.png' % model_name)
    plt.cla()

def tranformation(data, shift):
    result={
        party : [each+shift for each in values] for (party,values) in data.items()
    }
    return result

def get_stats(data,method):
    result={party:method(values) for (party,values) in data.items()}
    return result

def sort_data(data,column="Party_A"):
    df=pd.DataFrame(data)
    df.sort_values(by=column,axis=0,inplace=True,ignore_index=True)
    return df.to_dict(orient='list')


if __name__ == "__main__":
    #print(tranformation(CAC_ave,5832))
    #print(get_stats(CAC_single,np.average),get_stats(CAC_single,np.std))
    #print(sort_data(fund1e4))
    #show_data('CAC',lq1e3)
    #show_data('CAC',CAC_ave)
    for each in [sigma200,q10,lq1e3,buyint5,mul3,fund1e4]:
        name=retrieve_name(each)
        sensitivity(name,each)
        #print('-----------------%s------------------' % name)
        print('max_%s='% name,get_stats(each,np.max))
        print('min_%s='% name,get_stats(each,np.min))
        mean=get_stats(each,np.average)
        std=get_stats(each,np.std)
        arsd=np.array(list(std.values()))/np.array(list(mean.values()))
        arsd={'party_%d' % (index+1):value for index,value in enumerate(arsd)}
        print('arsd_%s=' % name,arsd)